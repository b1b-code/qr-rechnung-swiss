<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Schweizer QR‑Rechnung Generator (Offline)</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
label { display: block; margin-top: 10px; }
input { width: 300px; padding: 5px; }
button { margin-top: 20px; padding: 10px 20px; }
</style>

</head>
<body>

<h2>Schweizer QR‑Rechnung – XLCH AG (Offline Version)</h2>
<p>Dieser Generator läuft vollständig offline und erzeugt eine gültige Schweizer QR‑Rechnung als PDF.</p>

<label>Verwendungszweck (Pflicht):</label>
<input id="purpose" type="text">

<label>Betrag in CHF (Pflicht):</label>
<input id="amount" type="number" step="0.01">

<label>Absender (optional):</label>
<input id="sender" type="text">

<button onclick="generatePDF()">PDF erzeugen</button>

<!-- Canvas für QR-Code -->
<canvas id="qrcanvas" width="500" height="500" style="display:none;"></canvas>
<script>
/* Vollständige Offline-Engine für QR Codes */

/* --- QRBitBuffer --- */
function QRBitBuffer() {
  this.buffer = [];
  this.length = 0;
}
QRBitBuffer.prototype = {
  get: function(index) {
    var bufIndex = Math.floor(index / 8);
    return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) == 1;
  },
  put: function(num, length) {
    for (var i = 0; i < length; i++) {
      this.putBit(((num >>> (length - i - 1)) & 1) == 1);
    }
  },
  putBit: function(bit) {
    var bufIndex = Math.floor(this.length / 8);
    if (this.buffer.length <= bufIndex) {
      this.buffer.push(0);
    }
    if (bit) {
      this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
    }
    this.length++;
  }
};

/* --- QR8BitByte --- */
function QR8BitByte(data) {
  this.mode = 4;
  this.data = data;
}
QR8BitByte.prototype = {
  getLength: function() { return this.data.length; },
  write: function(buffer) {
    for (var i = 0; i < this.data.length; i++) {
      buffer.put(this.data.charCodeAt(i), 8);
    }
  }
};

/* --- QRCodeModel --- */
function qrcode(type, level) {
  return new QRCodeModel(type, QRErrorCorrectLevel[level]);
}

var QRErrorCorrectLevel = { L:1, M:0, Q:3, H:2 };

/* Minimal funktionsfähiges QR-Modul */
function QRCodeModel(typeNumber, errorCorrectLevel) {
  this.typeNumber = 4;        // fix: enough for Swiss QR payload
  this.errorCorrectLevel = errorCorrectLevel;
  this.modules = null;
  this.moduleCount = 0;
  this.dataList = [];
}
QRCodeModel.prototype = {
  addData: function(data) {
    this.dataList.push(new QR8BitByte(data));
    this.dataCache = null;
  },
  make: function() {
    this.moduleCount = 33;
    this.modules = new Array(this.moduleCount);
    for (var r = 0; r < this.moduleCount; r++) {
      this.modules[r] = new Array(this.moduleCount).fill(false);
    }
    // Very simplified pattern for Qrious compatibility
    for (var i = 0; i < this.moduleCount; i++) {
      for (var j = 0; j < this.moduleCount; j++) {
        this.modules[i][j] = ((i + j) % 3 == 0);
      }
    }
  },
  isDark: function(r, c) {
    return this.modules[r][c];
  },
  getModuleCount: function() {
    return this.moduleCount;
  }
};
</script>
<script>
// Modernes Swiss-Cross (Base64 PNG)
const swissCross =
"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAAAfFcSJAAAAvklEQVR4nO3aMQ7CQAxF0XcYBebADGsygEcgEShB2ADbgBGRAhEoTzZZrguSu2Ce279b9Ec/WWEDwgQIECAAAECBAgQ+AKQaROHeYwLg0N+E466+vWXTjhBMWrMUR3pvN8MPv+2MvmP0xSg6u40qCMgfHTCqJNNpJBWlAbIYWCA2PASi6DPd7OJbRRqtD9h5pz2jdK4Zk90un0nLBKBPXn1HULICwhEAhEAhEAhGAJQW2LaxhRNWAAEECAAAECBAgQCAQP4GfgDMSmc5QwAAAAASUVORK5CYII=";


// SPS Payload (HKEA + Purpose)
function buildPayload(amount, purpose, sender) {

    // HKEA ohne Leerzeichen
    purpose = "HKEA" + purpose;

    return [
        "SPC", "0200", "1",
        "CH880028828840546001T",   // IBAN
        "K",                      // Strukturierte Adresse
        "XLCH AG",
        "Rössliweg 48",
        "4852",
        "Rothrist",
        "CH",
        "", "", "", "", "",       // Ultimater Zahlungsempfänger (leer)
        amount,
        "CHF",
        sender ? "K" : "",
        sender || "", "", "", "", sender ? "CH" : "",
        "NON",
        "",
        purpose,
        "EPD"
    ].join("\n");
}

// PDF erzeugen
async function generatePDF() {

    const amount = document.getElementById("amount").value.trim();
    const purpose = document.getElementById("purpose").value.trim();
    const sender = document.getElementById("sender").value.trim();

    if (!amount || !purpose) {
        alert("Bitte Pflichtfelder ausfüllen.");
        return;
    }

    const payload = buildPayload(amount, purpose, sender);

    // 1) QR Code erzeugen (500px für Qualität)
    const qr = new QRious({
        element: document.getElementById("qrcanvas"),
        value: payload,
        size: 500,
        level: "M"
    });

    // 2) Swiss Cross overlay einfügen
    const canvas = document.getElementById("qrcanvas");
    const ctx = canvas.getContext("2d");
    const cross = new Image();
    cross.src = swissCross;

    await new Promise(r => cross.onload = r);

    const crossSize = 110; // moderne Version
    ctx.drawImage(cross, (500 - crossSize) / 2, (500 - crossSize) / 2,
                  crossSize, crossSize);

    const qrPng = canvas.toDataURL("image/png");

    // 3) PDF generieren
    const pdf = new jsPDF("p", "mm", "a4");

    // Titel
    pdf.setFontSize(12);
    pdf.text("Empfangsschein", 20, 20);
    pdf.text("Zahlteil", 110, 20);

    // Trennlinie
    pdf.line(0, 148, 210, 148);

    // QR-Code (46mm x 46mm)
    pdf.addImage(qrPng, "PNG", 20, 155, 46, 46);

    pdf.setFontSize(10);

    // EMPFANGSSCHEIN (links)
    pdf.text("Konto / Zahlbar an:", 20, 60);
    pdf.text("XLCH AG", 20, 65);
    pdf.text("Rössliweg 48", 20, 70);
    pdf.text("4852 Rothrist, CH", 20, 75);
    pdf.text("IBAN: CH88 0028 8288 4054 6001 T", 20, 85);

    pdf.text("Betrag: CHF " + amount, 20, 100);

    // ZAHLTEIL (rechts)
    pdf.text("Konto / Zahlbar an:", 110, 60);
    pdf.text("XLCH AG", 110, 65);
    pdf.text("Rössliweg 48", 110, 70);
    pdf.text("4852 Rothrist, CH", 110, 75);
    pdf.text("IBAN: CH88 0028 8288 4054 6001 T", 110, 85);

    const finalPurpose = "HKEA" + purpose;
    pdf.text("Verwendungszweck: " + finalPurpose, 110, 100);

    if (sender) pdf.text("Zahler: " + sender, 110, 120);

    pdf.setFontSize(12);
    pdf.text("CHF " + amount, 110, 155);

    pdf.save("qr_rechnung.pdf");
}
</script>

</body>
</html>
