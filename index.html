<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Swiss QR-Rechnung Generator</title>
</head>
<body>

<h2>Swiss QR‑Rechnung – XLCH AG (Online Version)</h2>
<p>Bitte Verwendungszweck und Betrag eingeben:</p>

<label>Verwendungszweck (Pflicht):</label>
<input id="purpose" type="text">

<label>Betrag in CHF (Pflicht):</label>
<input id="amount" type="number" step="0.01">

<label>Absender (optional):</label>
<input id="sender" type="text">

<button onclick="generatePDF()">PDF erzeugen</button>

<canvas id="qrcanvas" width="500" height="500" style="display:none;"></canvas>
<!-- QRCode.js auf jsDelivr -->
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

<!-- jsPDF auf jsDelivr -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- Swiss Cross -->
<script>
const swissCross =
"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAAAfFcSJAAAAvklEQVR4nO3aMQ7CQAxF0XcYBebADGsygEcgEShB2ADbgBGRAhEoTzZZrguSu2Ce279b9Ec/WWEDwgQIECAAAECBAgQ+AKQaROHeYwLg0N+E466+vWXTjhBMWrMUR3pvN8MPv+2MvmP0xSg6u40qCMgfHTCqJNNpJBWlAbIYWCA2PASi6DPd7OJbRRqtD9h5pz2jdK4Zk90un0nLBKBPXn1HULICwhEAhEAhEAhGAJQW2LaxhRNWAAEECAAAECBAgQCAQP4GfgDMSmc5QwAAAAASUVORK5CYII=";
</script>
<script>
function buildPayload(amount, purpose, sender) {
    const finalPurpose = "HKEA" + purpose;

    return [
        "SPC","0200","1",
        "CH880028828840546001T",
        "K","XLCH AG","Rössliweg 48","4852","Rothrist","CH",
        "","","","","",
        amount,"CHF",
        sender ? "K" : "",
        sender || "","","","", sender ? "CH" : "",
        "NON","",
        finalPurpose,
        "EPD"
    ].join("\n");
}

async function generatePDF() {
    const amount = document.getElementById("amount").value.trim();
    const purpose = document.getElementById("purpose").value.trim();
    const sender = document.getElementById("sender").value.trim();

    if(!amount || !purpose) {
        alert("Bitte Pflichtfelder ausfüllen.");
        return;
    }

    const payload = buildPayload(amount, purpose, sender);

    // QR-Code erzeugen
    document.getElementById("qrcanvas").style.display = "block";
    const container = document.getElementById("qrcanvas");
    container.innerHTML = "";

    const qrcode = new QRCode(container, {
        text: payload,
        width: 500,
        height: 500,
        correctLevel: QRCode.CorrectLevel.M
    });

    await new Promise(r => setTimeout(r, 500));

    // Canvas extrahieren (QRCode.js erzeugt ein <img>)
    const img = container.querySelector("img");
    const qrPng = img.src;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","mm","a4");

    // Layout
    pdf.setFontSize(12);
    pdf.text("Empfangsschein", 20, 20);
    pdf.text("Zahlteil", 110, 20);
    pdf.line(0, 148, 210, 148);

    // Swiss QR Code
    pdf.addImage(qrPng, "PNG", 20, 155, 46, 46);

    pdf.setFontSize(10);

    // Links
    pdf.text("Konto / Zahlbar an:", 20, 60);
    pdf.text("XLCH AG", 20, 65);
    pdf.text("Rössliweg 48", 20, 70);
    pdf.text("4852 Rothrist, CH", 20, 75);
    pdf.text("IBAN: CH88 0028 8288 4054 6001 T", 20, 85);
    pdf.text("Betrag: CHF " + amount, 20, 100);

    // Rechts
    const finalPurpose = "HKEA" + purpose;
    pdf.text("Konto / Zahlbar an:", 110, 60);
    pdf.text("XLCH AG", 110, 65);
    pdf.text("Rössliweg 48", 110, 70);
    pdf.text("4852 Rothrist, CH", 110, 75);
    pdf.text("IBAN: CH88 0028 8288 4054 6001 T", 110, 85);
    pdf.text("Verwendungszweck: " + finalPurpose, 110, 100);

    if (sender) {
        pdf.text("Zahler: " + sender, 110, 120);
    }

    pdf.setFontSize(12);
    pdf.text("CHF " + amount, 110, 155);

    pdf.save("qr_rechnung.pdf");
}
</script>

</body>
</html>
